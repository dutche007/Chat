<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Adviser Chat</title>
    <link rel="stylesheet" href="https://nhsuk.github.io/nhsuk-frontend/dist/nhsuk-7.1.0.min.css">
    <style>
        /* General Body and Container Styles */
        body {
            font-family: Arial, Helvetica, sans-serif;
            max-width: 960px; /* NHS standard width */
            margin: auto;
            padding: 20px;
            background-color: #fff;
            color: #000;
        }

        /* NHS-like Heading */
        h1.nhsuk-heading-xl {
            text-align: center;
            color: #005eb8; /* NHS Blue */
            margin-bottom: 24px;
        }

        /* Chatbox and Message Styles */
        #chatbox {
            border: 1px solid #d8dde0;
            height: 400px;
            overflow-y: scroll;
            padding: 15px;
            background-color: #f0f4f5;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        .message {
            margin: 10px 0;
            padding: 12px 16px;
            border-radius: 20px;
            max-width: 70%;
            clear: both;
            font-size: 1rem;
            line-height: 1.4;
        }
        .user {
            background-color: #005eb8; /* NHS Blue */
            color: #fff;
            float: right;
            border-radius: 20px 20px 0 20px;
            text-align: left;
        }
        .ai {
            background-color: #fff;
            color: #212b32;
            float: left;
            border: 1px solid #d8dde0;
            border-radius: 20px 20px 20px 0;
        }
        
        /* Control and Button Styles */
        #controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
            align-items: center;
        }
        input#userInput {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #d8dde0;
            border-radius: 4px;
            font-size: 1rem;
            color: #000;
        }
        select#modelSelect {
            padding: 10px;
            border: 1px solid #d8dde0;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 10px;
        }
        button {
            padding: 12px 20px;
            border: 1px solid #005eb8;
            border-radius: 4px;
            cursor: pointer;
            background-color: #fff;
            color: #005eb8;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        button:hover {
            background-color: #005eb8;
            color: #fff;
        }
        button:disabled {
            background-color: #d8dde0;
            color: #768692;
            border-color: #d8dde0;
            cursor: not-allowed;
        }
        .nhsuk-warning-callout {
            border-left-color: #ffb81c;
            border-left-width: 4px;
            padding: 16px;
            margin: 16px 0;
        }
        /* Typing indicator to fit the new theme */
        .typing-indicator span {
            background-color: #005eb8;
        }
    </style>
</head>
<body class="nhsuk-body">

<header class="nhsuk-header" role="banner" style="background-color: #fff;">
  <div class="nhsuk-width-container nhsuk-header__container">
    <div class="nhsuk-header__logo">
      <a class="nhsuk-header__link nhsuk-header__link--homepage" href="/" aria-label="Medical Adviser Chat">
        <svg class="nhsuk-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 16">
          <path class="nhsuk-logo__background" fill="#005eb8" d="M0 0h40v16H0z"></path>
          <path class="nhsuk-logo__text" fill="#fff" d="M3.987 1.558h1.22l2.35 11.237h.17l2.257-11.237h1.082L8.6 15.58H7.31L4.85 4.344h-.17L2.42 15.58H1.13zm15.82 0h-1.22l-2.35 11.237h-.17l-2.257-11.237h-1.082l2.35 11.237h.17l2.257-11.237z"></path>
        </svg>
      </a>
    </div>
  </div>
</header>
<main class="nhsuk-main-wrapper" id="maincontent" role="main">
    <div class="nhsuk-width-container">
        <h1 class="nhsuk-heading-xl">Your Medical Adviser</h1>

        <div class="nhsuk-warning-callout">
            <h3 class="nhsuk-warning-callout__label">Disclaimer</h3>
            <p>This service provides general health information and is not a substitute for professional medical advice. Always consult a qualified healthcare professional for any health concerns.</p>
        </div>

        <label for="modelSelect">Choose AI Model:</label>
        <select id="modelSelect" class="nhsuk-select">
            <option value="qwen/qwen-2.5-coder-32b-instruct:free">Qwen 2.5 Coder 32B (Free)</option>
            <option value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free">Dolphin Mistral 24B Venice (Free)</option>
            <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (Free)</option>
            <option value="mistralai/mistral-7b-instruct" selected>Mistral 7B (Free)</option>
            <option value="google/gemma-2-9b-it:free">Google Gemma 2 9B (Free)</option>
            <option value="deepseek/deepseek-r1-0528:free">DeepSeek R1 0528 (Free)</option>
            <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B (Free)</option>
            <option value="tngtech/deepseek-r1t-chimera:free">DeepSeek Chimera (Free)</option>
        </select>

        <div id="chatbox"></div>

        <div id="controls">
            <input type="text" id="userInput" placeholder="Type your message..." class="nhsuk-input">
            <button onclick="sendMessage()" class="nhsuk-button">Send</button>
            <button onclick="resetChat()" class="nhsuk-button nhsuk-button--secondary">Clear</button>
            <button onclick="stopSpeaking()" class="nhsuk-button nhsuk-button--secondary">Stop Voice</button>
            <button onclick="startListening()" class="nhsuk-button">ðŸŽ¤ Speak</button>
            <button onclick="stopListening()" class="nhsuk-button nhsuk-button--secondary">âœ– Stop Listening</button>
        </div>
    </div>
</main>
<script>
// Your existing JavaScript code remains the same.
let sessionId = Date.now().toString();
let isSpeaking = false;
let recognition;

// --- Initialize Speech Recognition if available ---
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.continuous = false;

    recognition.onstart = function() {
        toggleListeningUI(true);
    };
    recognition.onend = function() {
        toggleListeningUI(false);
    };

    recognition.onresult = function(event) {
        const speechText = event.results[0][0].transcript;
        document.getElementById('userInput').value = speechText;
        sendMessage();
    };

    recognition.onerror = function(event) {
        console.error('Speech recognition error', event.error);
        toggleListeningUI(false);
    };
} else {
    console.warn("Speech Recognition not supported in this browser.");
    document.querySelector('#controls button:nth-child(4)').style.display = 'none';
    document.querySelector('#controls button:nth-child(5)').style.display = 'none';
}

// --- STT controls ---
function startListening() { recognition?.start(); }
function stopListening() { recognition?.stop(); }

function toggleListeningUI(isListening) {
    const chatbox = document.getElementById('chatbox');
    const speakButton = document.querySelector('button[onclick="startListening()"]');
    if (isListening) {
        chatbox.classList.add('listening');
        speakButton.textContent = '...Listening';
    } else {
        chatbox.classList.remove('listening');
        speakButton.textContent = 'ðŸŽ¤ Speak';
    }
}

// --- Chat & TTS ---
async function sendMessage(retryInput) {
    const inputEl = document.getElementById('userInput');
    let text = retryInput || inputEl.value.trim();
    if (!text) return;

    if (!retryInput) addMessage(text, 'user');
    inputEl.value = '';

    const typingIndicator = addTypingIndicator();

    const modelSelect = document.getElementById('modelSelect');

    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: text, model: modelSelect.value, sessionId })
        });
        const data = await res.json();

        typingIndicator.remove();

        if (!res.ok) throw new Error(data.error || 'Unknown error');

        // Get the full AI response, which includes the thought process
        let fullReply = data.choices[0].message.content;

        // Check for the unique marker to separate the thought process from the final reply
        let finalReply = fullReply;
        const finalResponseMarker = '---FINAL---';
        if (fullReply.includes(finalResponseMarker)) {
            const parts = fullReply.split(finalResponseMarker);
            finalReply = parts[1].trim(); // Get the text after the marker and remove whitespace
        } else {
            // If the marker is not found, log a warning and use the full reply
            console.warn("Final response marker not found. The full response will be displayed.");
            console.log("Full AI response:", fullReply);
            finalReply = fullReply;
        }

        addMessage(finalReply, 'ai');
        speakText(finalReply);

    } catch (err) {
        console.error(err);
        typingIndicator.remove();

        const options = [...modelSelect.options];
        const currentIndex = options.findIndex(opt => opt.value === modelSelect.value);
        const nextIndex = (currentIndex + 1) % options.length;
        modelSelect.selectedIndex = nextIndex;

        addMessage(`Error encountered. Switching model to ${modelSelect.value} and retrying...`, 'ai');
        sendMessage(text);
    }
}

function addMessage(text, type) {
    const chatbox = document.getElementById('chatbox');
    const msg = document.createElement('div');
    msg.textContent = text;
    msg.className = 'message ' + type;
    chatbox.appendChild(msg);
    chatbox.scrollTop = chatbox.scrollHeight;
    return msg;
}

function addTypingIndicator() {
    const chatbox = document.getElementById('chatbox');
    const typingMsg = document.createElement('div');
    typingMsg.className = 'message ai typing-indicator';
    typingMsg.innerHTML = '<span></span><span></span><span></span>';
    chatbox.appendChild(typingMsg);
    chatbox.scrollTop = chatbox.scrollHeight;
    return typingMsg;
}

// --- Simplified TTS ---
function speakText(text) {
    stopSpeaking();
    // This line removes all emojis before the text is spoken
    const textWithoutEmojis = text.replace(/\p{Emoji_Presentation}/gu, '');
    const utterance = new SpeechSynthesisUtterance(textWithoutEmojis);
    const chatbox = document.getElementById('chatbox');
    utterance.onstart = () => chatbox.classList.add('speaking');
    utterance.onend = () => chatbox.classList.remove('speaking');
    speechSynthesis.speak(utterance);
}

function stopSpeaking() {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        document.getElementById('chatbox').classList.remove('speaking');
    }
}

function resetChat() {
    document.getElementById('chatbox').innerHTML = '';
    stopSpeaking();
    fetch('/api/reset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId })
    }).catch(err => console.error('Reset error:', err));
}

// --- Enter key submit, shift+Enter for new line ---
document.getElementById('userInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
</script>
</body>
</html>
